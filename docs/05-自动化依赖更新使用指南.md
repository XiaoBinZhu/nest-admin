# 自动化依赖更新使用指南

## 概述

本项目提供了多种方式来管理和更新依赖，包括手动检查、自动更新脚本和 Renovate 集成。

## 功能特性

- ✅ 依赖检查脚本
- ✅ Renovate 配置
- ✅ 更新文档
- ✅ 最佳实践指南

## 使用方法

### 方法一：使用 Renovate（推荐）

Renovate 是一个 GitHub 应用，可以自动创建 Pull Request 来更新依赖。

#### 启用步骤

1. 访问 [Renovate GitHub App](https://github.com/marketplace/renovate)
2. 点击 "Install" 并选择你的仓库
3. Renovate 会自动检测项目根目录下的 `renovate.json` 配置文件
4. 配置完成后，Renovate 会自动创建 PR 来更新依赖

#### 配置文件

项目已包含 `renovate.json` 配置文件：

```json
{
  "extends": [
    "config:base"
  ],
  "packageRules": [
    {
      "matchUpdateTypes": ["minor", "patch"],
      "matchCurrentVersion": "!/^0/",
      "automerge": true
    }
  ]
}
```

### 方法二：手动检查更新

#### 检查过时的依赖

```bash
pnpm update:deps:check
# 或
pnpm outdated
```

#### 运行更新脚本

```bash
pnpm update:deps
```

这个脚本会：
- 检查所有过时的依赖
- 提供更新建议

#### 更新依赖

```bash
# 更新所有依赖到最新兼容版本
pnpm update

# 更新特定包
pnpm update <package-name>

# 更新到最新版本（可能包含破坏性更改）
pnpm add <package-name>@latest
```

### 方法三：使用 npm-check-updates

如果需要更精细的控制，可以使用 `npm-check-updates`：

```bash
# 安装
pnpm add -D npm-check-updates

# 检查更新
npx ncu

# 更新 package.json（不安装）
npx ncu -u

# 然后安装
pnpm install
```

## 更新脚本说明

### update-dependencies.ts

位置：`scripts/update-dependencies.ts`

功能：
- 检查过时的依赖
- 提供更新建议
- 显示使用提示

使用：

```bash
pnpm tsx scripts/update-dependencies.ts
```

## 更新策略

### 1. Patch 版本更新

安全更新，通常只包含 bug 修复：

```bash
# 自动合并 patch 更新
pnpm update --latest
```

### 2. Minor 版本更新

新功能更新，通常向后兼容：

```bash
# 检查 minor 更新
pnpm outdated

# 选择性更新
pnpm update <package-name>
```

### 3. Major 版本更新

可能包含破坏性更改，需要仔细审查：

```bash
# 查看更新日志
npm view <package-name> versions

# 手动更新并测试
pnpm add <package-name>@latest
```

## 最佳实践

### 1. 定期更新

建议每月检查一次依赖更新：

```bash
# 添加到 cron 或 CI/CD
pnpm update:deps:check
```

### 2. 小步更新

优先更新 patch 和 minor 版本：

```bash
# 只更新 patch 版本
pnpm update --patch
```

### 3. 测试更新

更新后运行完整的测试套件：

```bash
pnpm test
pnpm test:e2e
```

### 4. 审查变更

使用版本控制工具审查依赖变更：

```bash
git diff package.json
git diff pnpm-lock.yaml
```

### 5. 锁定文件

提交 `pnpm-lock.yaml` 以确保一致性：

```bash
git add pnpm-lock.yaml
git commit -m "chore: update dependencies"
```

## 注意事项

1. **测试更新**：更新依赖后，务必运行测试确保一切正常
2. **检查破坏性更改**：查看包的 CHANGELOG 或 Release Notes
3. **锁定文件**：更新后检查 `pnpm-lock.yaml` 的变化
4. **生产环境**：在生产环境部署前，先在开发/测试环境验证
5. **安全更新**：优先更新包含安全补丁的版本

## 常见问题

### Q: 如何回退依赖更新？

A: 使用 Git 回退到之前的版本：

```bash
git checkout HEAD~1 -- package.json pnpm-lock.yaml
pnpm install
```

### Q: 如何处理依赖冲突？

A: 检查冲突的依赖，可能需要更新或替换：

```bash
pnpm why <package-name>
```

### Q: 如何更新所有依赖到最新版本？

A: 使用 `pnpm update --latest`，但要注意可能包含破坏性更改。

## 相关文件

- Renovate 配置：`renovate.json`
- 更新脚本：`scripts/update-dependencies.ts`
- 文档：`docs/automatic-update-dependencies.md`
