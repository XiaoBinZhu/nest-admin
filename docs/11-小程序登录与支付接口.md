# 小程序登录与支付接口说明

## 概览

- 小程序登录：微信 / 支付宝
- 支付渠道：微信支付 / 支付宝支付 / 云闪付（银联）
- 提供 mockMode，便于本地和联调阶段快速自测

## 环境变量

```env
# 小程序
WECHAT_MINIAPP_APPID=your-wx-appid
WECHAT_MINIAPP_SECRET=your-wx-secret
ALIPAY_MINIAPP_APPID=your-alipay-appid
ALIPAY_MINIAPP_PRIVATE_KEY=your-alipay-private-key
ALIPAY_MINIAPP_ALIPAY_PUBLIC_KEY=your-alipay-public-key
MINIAPP_MOCK_MODE=true           # mock 模式（默认 true）

# 支付
PAYMENT_MOCK_MODE=true           # mock 模式（默认 true）

WECHAT_PAY_APPID=your-wx-appid
WECHAT_PAY_MCHID=your-mch-id
WECHAT_PAY_API_V3_KEY=your-api-v3-key
WECHAT_PAY_NOTIFY_URL=https://your.domain/payments/notify/wechat

ALIPAY_APPID=your-alipay-appid
ALIPAY_PRIVATE_KEY=your-alipay-private-key
ALIPAY_SERVER_URL=https://openapi.alipay.com/gateway.do
ALIPAY_NOTIFY_URL=https://your.domain/payments/notify/alipay

UNIONPAY_MER_ID=your-unionpay-mer-id
UNIONPAY_CERT_PATH=path/to/cert.pfx
UNIONPAY_CERT_PWD=your-cert-password
UNIONPAY_NOTIFY_URL=https://your.domain/payments/notify/unionpay
```

## 小程序登录

### 微信小程序登录

- 路径：`POST /api/auth/miniapp/wechat`
- 入参：
  ```json
  { "code": "wx.login 返回的临时 code" }
  ```
- 返回：
  ```json
  {
    "provider": "wechat",
    "openId": "o_xxx",
    "sessionKey": "xxx",
    "unionId": "optional",
    "mock": true // mockMode 时存在
  }
  ```

### 支付宝小程序登录

- 路径：`POST /api/auth/miniapp/alipay`
- 入参：
  ```json
  { "authCode": "my.getAuthCode 获取的 authCode" }
  ```
- 返回：
  ```json
  {
    "provider": "alipay",
    "userId": "2088xxx",
    "openId": "2088xxx",
    "mock": true // mockMode 时存在
  }
  ```

> 说明：支付宝/微信生产环境请使用官方 SDK 完成签名与调用；当前示例在 mockMode 下直接返回模拟数据，便于自测。

## 支付接口

### 创建支付

- 路径：`POST /api/payments`
- 入参示例：
  ```json
  {
    "orderId": "ORDER123",
    "subject": "测试商品",
    "amount": 1.99,
    "channel": "wechat" // 可选: wechat | alipay | unionpay
  }
  ```
- 返回（mock 模式示例）：
  ```json
  {
    "mock": true,
    "channel": "wechat",
    "orderId": "ORDER123",
    "prepayId": "mock-prepay-ORDER123",
    "paySign": "mock-sign-ORDER123"
  }
  ```

### 支付回调

- 路径：
  - `POST /api/payments/notify/wechat`
  - `POST /api/payments/notify/alipay`
  - `POST /api/payments/notify/unionpay`
- 当前示例：记录 payload 并返回 `"success"`。生产环境请按官方验签流程处理。

## 模块与文件

- 配置：`src/config/miniapp.config.ts`, `src/config/payment.config.ts`
- 小程序登录：`src/modules/auth/miniapp/`
- 支付模块：`src/modules/payments/`
- 文档：本文件

## 生产接入建议

1. 打开 mockMode=false，补全所需证书和密钥。
2. 引入官方 SDK（微信支付 v3、Alipay SDK、云闪付/银联 SDK），替换当前示例中的下单/验签逻辑。
3. 严格校验回调签名，持久化订单与支付状态。
4. 按需补充风控与幂等处理（订单状态检查、重复通知处理）。
