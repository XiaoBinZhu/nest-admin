# 多数据库支持使用指南

## 概述

本项目支持多种数据库类型，包括关系型数据库（MySQL、PostgreSQL）和文档数据库（MongoDB）。通过配置可以灵活切换数据库类型，无需修改业务代码。

## 功能特性

- ✅ 支持 MySQL（默认）
- ✅ 支持 PostgreSQL
- ✅ 支持 MongoDB
- ✅ 自动根据配置选择数据库驱动
- ✅ 保持向后兼容，不影响现有功能

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 数据库类型: mysql | postgres | mongodb
DB_TYPE=mysql

# MySQL/PostgreSQL 配置
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=password
DB_DATABASE=nest_admin
DB_SYNCHRONIZE=false

# MongoDB 配置（当 DB_TYPE=mongodb 时）
# 方式1：使用连接字符串
DB_URL=mongodb://localhost:27017/nest_admin

# 方式2：使用单独配置（会自动构建连接字符串）
DB_HOST=localhost
DB_PORT=27017
DB_USERNAME=admin
DB_PASSWORD=password
DB_DATABASE=nest_admin
```

### 配置选项说明

| 配置项 | 说明 | 默认值 | 必填 |
|--------|------|--------|------|
| `DB_TYPE` | 数据库类型 | `mysql` | 否 |
| `DB_HOST` | 数据库主机 | `127.0.0.1` | 是 |
| `DB_PORT` | 数据库端口 | `3306` (MySQL) / `5432` (PostgreSQL) / `27017` (MongoDB) | 否 |
| `DB_USERNAME` | 数据库用户名 | - | 是 |
| `DB_PASSWORD` | 数据库密码 | - | 是 |
| `DB_DATABASE` | 数据库名称 | - | 是 |
| `DB_URL` | MongoDB 连接字符串（可选） | - | MongoDB 可选 |
| `DB_SYNCHRONIZE` | 是否自动同步表结构 | `false` | 否 |

## 使用方法

### 1. 使用关系型数据库（MySQL/PostgreSQL）

#### MySQL 配置

```env
DB_TYPE=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=password
DB_DATABASE=nest_admin
```

#### PostgreSQL 配置

```env
DB_TYPE=postgres
DB_HOST=127.0.0.1
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=password
DB_DATABASE=nest_admin
```

### 2. 使用 MongoDB

#### 方式1：使用连接字符串

```env
DB_TYPE=mongodb
DB_URL=mongodb://localhost:27017/nest_admin
```

#### 方式2：使用单独配置

```env
DB_TYPE=mongodb
DB_HOST=localhost
DB_PORT=27017
DB_USERNAME=admin
DB_PASSWORD=password
DB_DATABASE=nest_admin
```

### 3. 在代码中使用

#### TypeORM（关系型数据库）

```typescript
import { Column, Entity, PrimaryGeneratedColumn } from 'typeorm'

@Entity('users')
export class User {
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  username: string

  @Column()
  email: string
}
```

#### Mongoose（MongoDB）

```typescript
import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose'
import { Document } from 'mongoose'

@Schema()
export class User extends Document {
  @Prop()
  username: string

  @Prop()
  email: string
}

export const UserSchema = SchemaFactory.createForClass(User)
```

## 架构设计

### 数据库模块选择

系统会根据 `DB_TYPE` 配置自动选择数据库模块：

```typescript
const isDocumentDatabase = dbType === 'mongodb'

const infrastructureDatabaseModule = isDocumentDatabase
  ? MongooseModule.forRootAsync({
      useClass: MongooseConfigService,
    })
  : TypeOrmModule.forRootAsync({
      useClass: TypeOrmConfigService,
      dataSourceFactory: async (options) => {
        return new DataSource(options).initialize()
      },
    })
```

### 配置服务

#### TypeORM 配置服务

`TypeOrmConfigService` 负责配置关系型数据库连接。

#### Mongoose 配置服务

`MongooseConfigService` 负责配置 MongoDB 连接。

### 文件结构

```
src/shared/database/
├── database.module.ts           # 数据库模块（自动选择驱动）
├── typeorm-config.service.ts   # TypeORM 配置服务
├── mongoose-config.service.ts  # Mongoose 配置服务
└── constraints/                 # 数据库约束
```

## 迁移指南

### 从 MySQL 迁移到 PostgreSQL

1. 修改环境变量：

```env
DB_TYPE=postgres
DB_PORT=5432
```

2. 检查 SQL 语法差异（如 `LIMIT`、`OFFSET` 等）
3. 运行迁移：

```bash
pnpm migration:run
```

### 从关系型数据库迁移到 MongoDB

1. 修改环境变量：

```env
DB_TYPE=mongodb
DB_URL=mongodb://localhost:27017/nest_admin
```

2. 将 TypeORM 实体转换为 Mongoose Schema
3. 更新相关的 Repository 使用方式

## 注意事项

1. **数据迁移**：切换数据库类型时，需要手动迁移数据
2. **实体定义**：TypeORM 和 Mongoose 的实体定义方式不同
3. **查询语法**：不同数据库的查询语法可能有差异
4. **事务支持**：MongoDB 的事务支持与关系型数据库不同
5. **索引**：不同数据库的索引创建方式可能不同

## 最佳实践

1. **开发环境**：使用 MySQL 或 PostgreSQL
2. **生产环境**：根据业务需求选择合适的数据库
3. **数据一致性**：使用迁移脚本确保数据结构一致
4. **性能优化**：根据数据库类型优化查询语句

## 相关文件

- 数据库配置：`src/config/database.config.ts`
- 数据库模块：`src/shared/database/database.module.ts`
- TypeORM 配置：`src/shared/database/typeorm-config.service.ts`
- Mongoose 配置：`src/shared/database/mongoose-config.service.ts`
