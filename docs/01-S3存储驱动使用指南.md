# S3 存储驱动使用指南

## 概述

本项目支持多种文件存储驱动，包括本地存储、七牛云和 AWS S3。通过配置可以灵活切换存储方式，无需修改业务代码。

## 功能特性

- ✅ 支持本地文件存储
- ✅ 支持 AWS S3 存储
- ✅ 支持七牛云存储（保留原有功能）
- ✅ 统一的存储接口，易于扩展
- ✅ 配置化驱动选择

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 存储驱动选择: local | s3 | qiniu
STORAGE_DRIVER=local

# S3 配置（当 STORAGE_DRIVER=s3 时生效）
S3_ACCESS_KEY_ID=your-access-key-id
S3_SECRET_ACCESS_KEY=your-secret-access-key
S3_REGION=us-east-1
S3_BUCKET=your-bucket-name
# 可选：自定义 S3 兼容服务端点（如 MinIO）
S3_ENDPOINT=https://s3.example.com
```

### 配置选项说明

| 配置项 | 说明 | 默认值 | 必填 |
|--------|------|--------|------|
| `STORAGE_DRIVER` | 存储驱动类型 | `local` | 否 |
| `S3_ACCESS_KEY_ID` | AWS Access Key ID | - | S3 驱动必填 |
| `S3_SECRET_ACCESS_KEY` | AWS Secret Access Key | - | S3 驱动必填 |
| `S3_REGION` | AWS 区域 | `us-east-1` | S3 驱动必填 |
| `S3_BUCKET` | S3 存储桶名称 | - | S3 驱动必填 |
| `S3_ENDPOINT` | 自定义端点（兼容 MinIO 等） | - | 否 |

## 使用方法

### 1. 文件上传

使用统一的接口上传文件，系统会根据配置自动选择存储驱动：

```typescript
// 在 Controller 中使用
@Post('upload')
async upload(@Req() req: FastifyRequest, @AuthUser() user: IAuthUser) {
  const file = await req.file()
  const path = await this.uploadService.saveFile(file, user.uid)
  return { filename: path }
}
```

### 2. 切换存储驱动

只需修改环境变量即可切换存储方式：

```bash
# 使用本地存储
STORAGE_DRIVER=local

# 切换到 S3
STORAGE_DRIVER=s3
S3_ACCESS_KEY_ID=your-key
S3_SECRET_ACCESS_KEY=your-secret
S3_REGION=us-east-1
S3_BUCKET=your-bucket
```

### 3. 使用 MinIO 等 S3 兼容服务

```env
STORAGE_DRIVER=s3
S3_ACCESS_KEY_ID=minioadmin
S3_SECRET_ACCESS_KEY=minioadmin
S3_REGION=us-east-1
S3_BUCKET=my-bucket
S3_ENDPOINT=http://localhost:9000
```

## 架构设计

### 存储驱动接口

所有存储驱动都实现 `IStorageDriver` 接口：

```typescript
interface IStorageDriver {
  upload: (file: MultipartFile, key: string) => Promise<UploadResult>
  delete: (key: string) => Promise<void>
  getUrl: (key: string) => Promise<string>
}
```

### 驱动工厂

`StorageDriverFactory` 根据配置自动创建对应的存储驱动实例。

### 文件结构

```
src/modules/tools/upload/
├── drivers/
│   ├── local-storage.driver.ts    # 本地存储驱动
│   ├── s3-storage.driver.ts       # S3 存储驱动
│   └── storage-driver.factory.ts  # 驱动工厂
├── interfaces/
│   └── storage-driver.interface.ts # 存储驱动接口
├── upload.service.ts               # 上传服务
└── upload.module.ts                # 上传模块
```

## 扩展新的存储驱动

如果需要添加新的存储驱动（如阿里云 OSS、腾讯云 COS），只需：

1. 实现 `IStorageDriver` 接口
2. 在 `StorageDriverFactory` 中注册新驱动
3. 在配置中添加对应的环境变量

示例：

```typescript
@Injectable()
export class AliyunOssDriver implements IStorageDriver {
  async upload(file: MultipartFile, key: string): Promise<UploadResult> {
    // 实现上传逻辑
  }

  async delete(key: string): Promise<void> {
    // 实现删除逻辑
  }

  async getUrl(key: string): Promise<string> {
    // 实现获取 URL 逻辑
  }
}
```

## 注意事项

1. **文件路径格式**：所有驱动使用统一的路径格式 `/upload/YYYY-MM-DD/类型/文件名`
2. **S3 Key 格式**：S3 存储时会自动移除路径开头的 `/`
3. **URL 生成**：
   - 本地存储：返回相对路径，由静态文件服务提供访问
   - S3 存储：返回完整的 S3 URL 或自定义端点 URL
4. **错误处理**：所有驱动都应妥善处理错误，避免影响业务逻辑

## 测试

运行 E2E 测试验证上传功能：

```bash
pnpm test:e2e
```

## 相关文件

- 配置文件：`src/config/oss.config.ts`
- 上传服务：`src/modules/tools/upload/upload.service.ts`
- 存储驱动：`src/modules/tools/upload/drivers/`
