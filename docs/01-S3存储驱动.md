# S3 存储驱动使用指南

## 概述

nest-admin 现在支持多种文件存储驱动，包括本地存储、七牛云和 AWS S3。本文档介绍如何配置和使用 S3 存储驱动。

## 功能特性

- ✅ 支持 AWS S3 标准协议
- ✅ 支持兼容 S3 协议的其他服务（如 MinIO）
- ✅ 可配置的存储驱动切换
- ✅ 统一的存储接口，无需修改业务代码

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 存储驱动类型：local | qiniu | s3
STORAGE_DRIVER=s3

# S3 配置
S3_ACCESS_KEY_ID=your-access-key-id
S3_SECRET_ACCESS_KEY=your-secret-access-key
S3_REGION=us-east-1
S3_BUCKET=your-bucket-name

# 可选：自定义 S3 端点（用于 MinIO 等兼容服务）
S3_ENDPOINT=http://localhost:9000
```

### 配置项说明

| 配置项 | 说明 | 必填 | 默认值 |
|--------|------|------|--------|
| `STORAGE_DRIVER` | 存储驱动类型 | 是 | `local` |
| `S3_ACCESS_KEY_ID` | AWS Access Key ID | 是（使用 S3 时） | - |
| `S3_SECRET_ACCESS_KEY` | AWS Secret Access Key | 是（使用 S3 时） | - |
| `S3_REGION` | AWS 区域 | 是（使用 S3 时） | `us-east-1` |
| `S3_BUCKET` | S3 存储桶名称 | 是（使用 S3 时） | - |
| `S3_ENDPOINT` | 自定义端点（MinIO 等） | 否 | - |

## 使用方法

### 1. 上传文件

使用现有的上传接口，无需修改代码：

```typescript
// POST /tools/upload
// Content-Type: multipart/form-data
// Body: file (文件)

// 响应
{
  "filename": "/upload/2024-01-01/图片/image-20240101120000.jpg"
}
```

### 2. 在代码中使用存储驱动

```typescript
import { Injectable } from '@nestjs/common'
import { StorageDriverFactory } from '~/modules/tools/upload/drivers/storage-driver.factory'

@Injectable()
export class MyService {
  constructor(private storageDriverFactory: StorageDriverFactory) {}

  async uploadFile(file: MultipartFile, key: string) {
    const driver = this.storageDriverFactory.create()
    const result = await driver.upload(file, key)
    return result
  }
}
```

### 3. 切换存储驱动

只需修改环境变量 `STORAGE_DRIVER`，无需修改代码：

```env
# 切换到本地存储
STORAGE_DRIVER=local

# 切换到 S3
STORAGE_DRIVER=s3

# 切换到七牛云
STORAGE_DRIVER=qiniu
```

## 架构设计

### 存储驱动接口

所有存储驱动都实现 `IStorageDriver` 接口：

```typescript
interface IStorageDriver {
  upload: (file: MultipartFile, key: string) => Promise<UploadResult>
  delete: (key: string) => Promise<void>
  getUrl: (key: string) => Promise<string>
}
```

### 驱动实现

- **LocalStorageDriver**: 本地文件系统存储
- **S3StorageDriver**: AWS S3 存储
- **QiniuStorageDriver**: 七牛云存储（待实现）

### 工厂模式

使用 `StorageDriverFactory` 根据配置自动选择驱动：

```typescript
const driver = storageDriverFactory.create()
```

## 注意事项

1. **S3 权限配置**：确保 AWS IAM 用户具有以下权限：
   - `s3:PutObject` - 上传文件
   - `s3:GetObject` - 获取文件
   - `s3:DeleteObject` - 删除文件

2. **MinIO 配置**：使用 MinIO 时，设置 `S3_ENDPOINT` 为 MinIO 服务器地址

3. **文件路径**：S3 存储时，文件路径会自动移除开头的 `/`，符合 S3 key 规范

4. **URL 生成**：
   - 标准 S3：`https://bucket.s3.region.amazonaws.com/key`
   - 自定义端点：`{endpoint}/{bucket}/{key}`

## 故障排查

### 问题：上传失败

**检查项**：
1. 验证 AWS 凭证是否正确
2. 检查 S3 存储桶是否存在
3. 确认 IAM 权限配置
4. 查看服务器日志获取详细错误信息

### 问题：URL 无法访问

**检查项**：
1. 存储桶的公共访问策略
2. 文件对象的 ACL 设置
3. 自定义端点的网络连接

## 示例代码

### 完整上传示例

```typescript
import { Controller, Post, UploadedFile, UseInterceptors } from '@nestjs/common'
import { FileInterceptor } from '@nestjs/platform-express'
import { StorageDriverFactory } from './drivers/storage-driver.factory'

@Controller('upload')
export class UploadController {
  constructor(private storageDriverFactory: StorageDriverFactory) {}

  @Post()
  @UseInterceptors(FileInterceptor('file'))
  async upload(@UploadedFile() file: Express.Multer.File) {
    const driver = this.storageDriverFactory.create()
    const key = `/upload/${Date.now()}/${file.originalname}`
    const result = await driver.upload(file, key)
    return result
  }
}
```

## 相关文档

- [AWS S3 官方文档](https://docs.aws.amazon.com/s3/)
- [MinIO 文档](https://min.io/docs/)
- [文件上传模块文档](./02-文件上传.md)
