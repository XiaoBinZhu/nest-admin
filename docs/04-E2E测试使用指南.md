# E2E 测试使用指南

## 概述

本项目已集成 E2E（端到端）测试框架，提供了完整的测试基础设施和示例测试用例。

## 功能特性

- ✅ Jest 测试框架
- ✅ Supertest HTTP 测试
- ✅ 认证模块测试示例
- ✅ 上传模块测试示例
- ✅ 测试工具和常量

## 配置说明

### Jest E2E 配置

配置文件位于 `test/jest-e2e.json`：

```json
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  },
  "moduleNameMapper": {
    "^~/(.*)$": "<rootDir>/../src/$1"
  }
}
```

### 测试常量

测试常量定义在 `test/utils/constants.ts`：

```typescript
export const APP_URL = `http://localhost:${process.env.APP_PORT || 3000}`
export const TESTER_USERNAME = 'test'
export const TESTER_PASSWORD = '123456'
export const ADMIN_USERNAME = 'admin'
export const ADMIN_PASSWORD = 'admin123'
```

## 运行测试

### 运行所有 E2E 测试

```bash
pnpm test:e2e
```

### 运行特定测试文件

```bash
pnpm test:e2e -- test/auth/auth.e2e-spec.ts
```

### 监听模式运行

```bash
pnpm test:e2e -- --watch
```

## 测试示例

### 1. 认证模块测试

文件：`test/auth/auth.e2e-spec.ts`

```typescript
import request from 'supertest'
import { APP_URL, TESTER_PASSWORD, TESTER_USERNAME } from '../utils/constants'

describe('Auth Module (e2e)', () => {
  const app = APP_URL
  let authToken: string

  describe('Login', () => {
    it('should fail with invalid credentials', () => {
      return request(app)
        .post('/auth/login')
        .send({
          username: 'invalid',
          password: 'invalid',
          captchaId: 'test',
          verifyCode: '1234',
        })
        .expect(401)
    })

    it('should successfully login', () => {
      return request(app)
        .post('/auth/login')
        .send({
          username: TESTER_USERNAME,
          password: TESTER_PASSWORD,
          captchaId: 'test',
          verifyCode: '1234',
        })
        .expect(200)
        .expect(({ body }) => {
          expect(body.token).toBeDefined()
          authToken = body.token
        })
    })
  })
})
```

### 2. 上传模块测试

文件：`test/upload/upload.e2e-spec.ts`

```typescript
import request from 'supertest'
import { APP_URL, TESTER_PASSWORD, TESTER_USERNAME } from '../utils/constants'

describe('Upload Module (e2e)', () => {
  const app = APP_URL
  let authToken: string

  beforeAll(async () => {
    // 登录获取 token
    const response = await request(app)
      .post('/auth/login')
      .send({
        username: TESTER_USERNAME,
        password: TESTER_PASSWORD,
      })
    authToken = response.body.accessToken
  })

  it('should upload file successfully', () => {
    return request(app)
      .post('/tools/upload')
      .set('Authorization', `Bearer ${authToken}`)
      .attach('file', 'test/fixtures/test-image.jpg')
      .expect(200)
      .expect(({ body }) => {
        expect(body.filename).toBeDefined()
      })
  })
})
```

## 编写新测试

### 1. 创建测试文件

在 `test/` 目录下创建新的测试文件，命名格式：`*.e2e-spec.ts`

```typescript
import request from 'supertest'
import { APP_URL } from '../utils/constants'

describe('Your Module (e2e)', () => {
  const app = APP_URL

  it('should do something', () => {
    return request(app)
      .get('/your-endpoint')
      .expect(200)
  })
})
```

### 2. 测试结构

```typescript
describe('Module Name (e2e)', () => {
  // 测试前的准备工作
  beforeAll(async () => {
    // 初始化数据、登录等
  })

  // 测试后的清理工作
  afterAll(async () => {
    // 清理数据
  })

  describe('Feature Group', () => {
    it('should do something', () => {
      // 测试逻辑
    })
  })
})
```

### 3. 常用测试模式

#### 测试认证接口

```typescript
it('should require authentication', () => {
  return request(app)
    .get('/protected-endpoint')
    .expect(401)
})

it('should access with valid token', () => {
  return request(app)
    .get('/protected-endpoint')
    .set('Authorization', `Bearer ${authToken}`)
    .expect(200)
})
```

#### 测试数据验证

```typescript
it('should validate input', () => {
  return request(app)
    .post('/endpoint')
    .send({ invalid: 'data' })
    .expect(400)
    .expect(({ body }) => {
      expect(body.message).toBeDefined()
    })
})
```

#### 测试文件上传

```typescript
it('should upload file', () => {
  return request(app)
    .post('/upload')
    .set('Authorization', `Bearer ${authToken}`)
    .attach('file', 'path/to/file.jpg')
    .expect(200)
})
```

## 测试最佳实践

### 1. 测试隔离

每个测试应该独立运行，不依赖其他测试的结果：

```typescript
beforeEach(async () => {
  // 每个测试前重置数据
  await resetDatabase()
})
```

### 2. 使用测试数据

创建专门的测试数据，避免使用生产数据：

```typescript
const testUser = {
  username: `test-${Date.now()}`,
  password: 'test123',
  email: `test-${Date.now()}@example.com`
}
```

### 3. 清理测试数据

测试后清理创建的数据：

```typescript
afterAll(async () => {
  await cleanupTestData()
})
```

### 4. 测试断言

使用清晰的断言，提供有意义的错误消息：

```typescript
expect(response.body).toHaveProperty('id')
expect(response.body.username).toBe(testUser.username)
```

## 调试测试

### 1. 使用 console.log

```typescript
it('should do something', async () => {
  const response = await request(app)
    .get('/endpoint')

  console.log('Response:', response.body)
  expect(response.status).toBe(200)
})
```

### 2. 使用 --verbose

```bash
pnpm test:e2e -- --verbose
```

### 3. 运行单个测试

```bash
pnpm test:e2e -- -t "should login successfully"
```

## 注意事项

1. **测试环境**：确保测试环境与开发/生产环境隔离
2. **数据库**：使用独立的测试数据库
3. **端口**：确保测试服务器运行在正确的端口
4. **异步操作**：正确处理异步操作和 Promise
5. **超时设置**：为长时间运行的测试设置合适的超时时间

## 相关文件

- E2E 配置：`test/jest-e2e.json`
- 测试常量：`test/utils/constants.ts`
- 认证测试：`test/auth/auth.e2e-spec.ts`
- 上传测试：`test/upload/upload.e2e-spec.ts`
