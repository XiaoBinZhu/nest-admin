# I18N 国际化使用指南

## 概述

本项目已集成 `nestjs-i18n`，支持多语言功能。系统会根据请求头、用户偏好等信息自动选择语言，并提供统一的翻译接口。

## 功能特性

- ✅ 支持多语言切换（中文、英文等）
- ✅ 智能语言解析（用户偏好 → header → Accept-Language → 默认）
- ✅ 全局异常消息多语言化
- ✅ 验证消息多语言化
- ✅ 易于扩展新语言

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 默认语言（fallback language）
APP_FALLBACK_LANGUAGE=zh

# 自定义语言 header 名称
APP_HEADER_LANGUAGE=x-custom-lang
```

### 配置选项说明

| 配置项 | 说明 | 默认值 | 必填 |
|--------|------|--------|------|
| `APP_FALLBACK_LANGUAGE` | 默认语言代码 | `zh` | 否 |
| `APP_HEADER_LANGUAGE` | 自定义语言 header 名称 | `x-custom-lang` | 否 |

## 语言解析优先级

系统按以下优先级解析语言：

1. **用户偏好**（如果用户已登录，可从用户实体获取）
2. **自定义 Header**：`x-custom-lang`（可配置）
3. **Accept-Language Header**：浏览器自动发送的语言偏好
4. **默认语言**：`APP_FALLBACK_LANGUAGE` 配置的值

## 使用方法

### 1. 前端设置语言

#### 方式1：使用自定义 Header

```javascript
// Axios 示例
axios.get('/api/users', {
  headers: {
    'x-custom-lang': 'en' // 或 'zh'
  }
})
```

#### 方式2：使用 Accept-Language

浏览器会自动发送 `Accept-Language` header，无需手动设置。

### 2. 在代码中使用翻译

#### 在 Service 中使用

```typescript
import { Injectable } from '@nestjs/common'
import { I18nContext } from 'nestjs-i18n'

@Injectable()
export class UserService {
  async getUser() {
    const i18n = I18nContext.current()

    if (!i18n) {
      throw new Error('I18nContext is not available')
    }

    // 翻译消息
    const message = i18n.t('common.confirmEmail')

    return { message }
  }
}
```

#### 在 Controller 中使用

```typescript
import { Controller, Get } from '@nestjs/common'
import { I18nContext } from 'nestjs-i18n'

@Controller('users')
export class UserController {
  @Get()
  async getUsers() {
    const i18n = I18nContext.current()
    const message = i18n?.t('common.confirmEmail') || 'Confirm Email'

    return { message }
  }
}
```

#### 使用参数化翻译

```typescript
// 翻译文件
{
  "welcome": "欢迎, {{name}}!"
}

// 代码中使用
const message = i18n.t('common.welcome', { args: { name: 'John' } })
// 输出: "欢迎, John!"
```

### 3. 翻译文件结构

```
src/i18n/
├── zh/              # 中文翻译
│   ├── common.json  # 通用消息
│   └── error.json   # 错误消息
└── en/              # 英文翻译
    ├── common.json
    └── error.json
```

### 4. 添加新语言

1. 在 `src/i18n/` 下创建新语言文件夹（如 `ja` 表示日语）
2. 复制现有语言文件并翻译
3. 系统会自动识别新语言

示例：

```bash
# 创建日语翻译目录
mkdir -p src/i18n/ja

# 复制并翻译文件
cp src/i18n/en/common.json src/i18n/ja/common.json
cp src/i18n/en/error.json src/i18n/ja/error.json
```

### 5. 翻译文件示例

#### common.json

```json
{
  "confirmEmail": "确认邮箱",
  "serverError": "服务器错误",
  "validationError": "验证失败",
  "unauthorized": "未授权",
  "forbidden": "禁止访问",
  "notFound": "资源未找到",
  "badRequest": "请求错误"
}
```

#### error.json

```json
{
  "USER_NOT_FOUND": "用户不存在",
  "INVALID_USERNAME_PASSWORD": "用户名或密码错误",
  "SERVER_ERROR": "服务器内部错误"
}
```

## 全局异常多语言化

系统已自动集成异常消息的多语言化。当抛出异常时，系统会：

1. 尝试从 `error.json` 中获取翻译
2. 如果找不到，尝试从 `common.json` 中获取
3. 如果都找不到，使用原始错误消息

示例：

```typescript
// 抛出业务异常
throw new BusinessException(ErrorEnum.USER_NOT_FOUND)

// 系统会自动翻译为：
// 中文: "用户不存在"
// 英文: "User not found"
```

## 验证消息多语言化

验证消息可以通过 DTO 装饰器配置：

```typescript
import { ApiProperty } from '@nestjs/swagger'
import { IsEmail, IsNotEmpty } from 'class-validator'

export class CreateUserDto {
  @ApiProperty({ description: '邮箱' })
  @IsEmail({}, { message: 'validation.INVALID_EMAIL' })
  @IsNotEmpty({ message: 'validation.EMAIL_REQUIRED' })
  email: string
}
```

然后在翻译文件中添加：

```json
{
  "validation": {
    "INVALID_EMAIL": "邮箱格式不正确",
    "EMAIL_REQUIRED": "邮箱是必填项"
  }
}
```

## 自定义语言解析器

如果需要自定义语言解析逻辑，可以修改 `CustomLanguageResolver`：

```typescript
// src/common/resolvers/custom-language.resolver.ts
resolve(context: any): string | undefined {
  const request = context.switchToHttp().getRequest<FastifyRequest>()

  // 1. 从用户偏好获取
  const user = request.user
  if (user?.language) {
    return user.language
  }

  // 2. 从自定义 header 获取
  // ...

  return undefined
}
```

## 注意事项

1. **翻译文件格式**：必须使用 JSON 格式，UTF-8 编码
2. **翻译键命名**：建议使用点分隔的层级结构（如 `common.confirmEmail`）
3. **默认值**：使用 `defaultValue` 参数提供回退值
4. **性能**：翻译文件会在开发模式下自动监听变化，生产环境建议禁用

## 最佳实践

1. **统一命名**：使用一致的翻译键命名规范
2. **模块化**：按功能模块组织翻译文件
3. **参数化**：使用参数化翻译提高复用性
4. **测试**：为所有语言提供完整的翻译

## 相关文件

- I18N 配置：`src/app.module.ts`
- 语言解析器：`src/common/resolvers/custom-language.resolver.ts`
- 异常过滤器：`src/common/filters/any-exception.filter.ts`
- 翻译文件：`src/i18n/`
