# 依赖更新使用指南

## 概述

本文档介绍如何自动或手动更新 nest-admin 项目的依赖包，保持项目依赖的最新状态。

## 功能特性

- ✅ Renovate 自动更新配置
- ✅ 手动检查更新脚本
- ✅ 依赖更新文档

## 自动更新（推荐）

### 使用 Renovate

Renovate 是一个 GitHub 应用，可以自动创建 Pull Request 来更新依赖。

#### 启用步骤

1. 访问 [Renovate GitHub App](https://github.com/marketplace/renovate)
2. 点击 "Install" 并选择你的仓库
3. Renovate 会自动检测项目根目录下的 `renovate.json` 配置文件
4. 配置完成后，Renovate 会自动创建 PR 来更新依赖

#### 配置文件

项目已包含 `renovate.json` 配置文件：

```json
{
  "extends": [
    "config:base"
  ],
  "packageRules": [
    {
      "matchUpdateTypes": ["minor", "patch"],
      "matchCurrentVersion": "!/^0/",
      "automerge": true
    }
  ]
}
```

#### 配置说明

- `extends`: 继承基础配置
- `packageRules`: 包更新规则
  - `matchUpdateTypes`: 匹配更新类型（minor, patch）
  - `matchCurrentVersion`: 匹配当前版本（排除 0.x 版本）
  - `automerge`: 自动合并（仅适用于 minor 和 patch 版本）

## 手动更新

### 检查过时的依赖

```bash
# 使用内置脚本
pnpm update:deps:check

# 或直接使用 pnpm
pnpm outdated
```

### 运行更新脚本

```bash
pnpm update:deps
```

这个脚本会：
- 检查所有过时的依赖
- 提供更新建议

### 更新依赖

#### 更新所有依赖

```bash
# 更新到最新兼容版本
pnpm update
```

#### 更新特定包

```bash
# 更新特定包到最新兼容版本
pnpm update <package-name>

# 更新到最新版本（可能包含破坏性更改）
pnpm add <package-name>@latest
```

#### 更新开发依赖

```bash
pnpm update -D
```

## 使用 npm-check-updates

如果需要更精细的控制，可以使用 `npm-check-updates`：

### 安装

```bash
pnpm add -D npm-check-updates
```

### 检查更新

```bash
npx ncu
```

### 更新 package.json

```bash
# 更新 package.json（不安装）
npx ncu -u

# 然后安装
pnpm install
```

## 更新策略

### 1. 小版本更新（Patch）

- **风险**：低
- **建议**：自动更新
- **命令**：`pnpm update`

### 2. 次版本更新（Minor）

- **风险**：中
- **建议**：测试后更新
- **命令**：`pnpm update`

### 3. 主版本更新（Major）

- **风险**：高
- **建议**：仔细审查后更新
- **命令**：`pnpm add <package>@latest`

## 更新流程

### 1. 检查更新

```bash
pnpm update:deps:check
```

### 2. 查看更新内容

查看包的 CHANGELOG 或 Release Notes

### 3. 更新依赖

```bash
pnpm update
```

### 4. 运行测试

```bash
pnpm test
pnpm test:e2e
```

### 5. 检查锁定文件

```bash
git diff pnpm-lock.yaml
```

### 6. 提交更改

```bash
git add package.json pnpm-lock.yaml
git commit -m "chore: update dependencies"
```

## 注意事项

### 1. 测试更新

更新依赖后，务必运行测试确保一切正常：

```bash
pnpm test
pnpm test:e2e
```

### 2. 检查破坏性更改

查看包的 CHANGELOG 或 Release Notes，了解是否有破坏性更改。

### 3. 锁定文件

更新后检查 `pnpm-lock.yaml` 的变化，确保锁定文件正确更新。

### 4. 生产环境

在生产环境部署前，先在开发/测试环境验证更新后的依赖。

### 5. 回滚

如果更新后出现问题，可以回滚到之前的版本：

```bash
git checkout package.json pnpm-lock.yaml
pnpm install
```

## 最佳实践

### 1. 定期更新

建议每月检查一次依赖更新，保持依赖的最新状态。

### 2. 小步更新

优先更新 patch 和 minor 版本，降低风险。

### 3. 测试先行

更新后运行完整的测试套件，确保功能正常。

### 4. 审查变更

使用版本控制工具审查依赖变更，了解更新的内容。

### 5. 文档记录

记录重要的依赖更新，特别是主版本更新。

## 故障排查

### 问题：更新后构建失败

**解决方案**：
1. 检查 Node.js 版本兼容性
2. 查看错误日志
3. 回滚到之前的版本
4. 检查包的兼容性说明

### 问题：更新后测试失败

**解决方案**：
1. 查看测试错误信息
2. 检查包的破坏性更改
3. 更新测试代码
4. 联系包维护者

### 问题：依赖冲突

**解决方案**：
1. 使用 `pnpm why <package>` 查看依赖关系
2. 解决版本冲突
3. 使用 `pnpm dedupe` 去重依赖

## 相关文档

- [Renovate 官方文档](https://docs.renovatebot.com/)
- [pnpm 官方文档](https://pnpm.io/)
- [npm-check-updates 文档](https://github.com/raineorshine/npm-check-updates)
