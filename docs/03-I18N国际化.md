# I18N 国际化使用指南

## 概述

nest-admin 现在支持多语言国际化（I18N），可以根据用户的语言偏好自动返回对应语言的错误消息和提示信息。本文档介绍如何配置和使用 I18N 功能。

## 功能特性

- ✅ 支持中文（zh）和英文（en）
- ✅ 自动语言检测（用户偏好 → header → Accept-Language → 默认）
- ✅ 错误消息多语言化
- ✅ 易于扩展新语言
- ✅ 与现有代码兼容

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 默认语言（fallback language）
APP_FALLBACK_LANGUAGE=zh

# 自定义语言 header 名称
APP_HEADER_LANGUAGE=x-custom-lang
```

### 配置项说明

| 配置项 | 说明 | 必填 | 默认值 |
|--------|------|------|--------|
| `APP_FALLBACK_LANGUAGE` | 默认语言 | 否 | `zh` |
| `APP_HEADER_LANGUAGE` | 自定义语言 header 名称 | 否 | `x-custom-lang` |

## 语言资源文件

### 文件结构

```
src/i18n/
├── zh/
│   ├── common.json    # 通用消息
│   └── error.json     # 错误消息
└── en/
    ├── common.json
    └── error.json
```

### 添加新的语言资源

1. 复制现有语言文件夹（如 `zh`）
2. 重命名为目标语言代码（如 `ja` 表示日语）
3. 翻译所有 JSON 文件中的内容

## 使用方法

### 1. 在请求中指定语言

#### 方式一：使用自定义 Header（推荐）

```http
GET /api/users
x-custom-lang: en
```

#### 方式二：使用 Accept-Language Header

```http
GET /api/users
Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8
```

#### 方式三：从用户偏好获取（需实现）

在 `CustomLanguageResolver` 中取消注释用户偏好代码：

```typescript
const user = request.user
if (user?.language) {
  return user.language
}
```

### 2. 在代码中使用 I18N

#### 在服务中使用

```typescript
import { Injectable } from '@nestjs/common'
import { I18nContext } from 'nestjs-i18n'

@Injectable()
export class UserService {
  async getMessage() {
    const i18n = I18nContext.current()

    if (!i18n) {
      throw new Error('I18nContext is not available')
    }

    // 获取翻译
    const message = i18n.t('common.confirmEmail')
    return message
  }
}
```

#### 在控制器中使用

```typescript
import { Controller, Get } from '@nestjs/common'
import { I18nContext, I18nLang } from 'nestjs-i18n'

@Controller('users')
export class UserController {
  @Get()
  async findAll(@I18nLang() lang: string) {
    const i18n = I18nContext.current()
    const message = i18n?.t('common.confirmEmail') || 'Confirm Email'
    return { lang, message }
  }
}
```

### 3. 错误消息自动翻译

系统会自动翻译以下类型的错误消息：

- **BusinessException**: 业务异常
- **HttpException**: HTTP 异常

错误消息会根据请求的语言自动返回对应语言的翻译。

## 语言解析优先级

系统按以下优先级解析语言：

1. **用户偏好**（如果已实现）
2. **自定义 Header** (`x-custom-lang`)
3. **Accept-Language Header**
4. **默认语言** (`APP_FALLBACK_LANGUAGE`)

## 添加新的翻译键

### 1. 在语言资源文件中添加

编辑 `src/i18n/zh/common.json`：

```json
{
  "confirmEmail": "确认邮箱",
  "welcome": "欢迎使用 nest-admin"
}
```

编辑 `src/i18n/en/common.json`：

```json
{
  "confirmEmail": "Confirm Email",
  "welcome": "Welcome to nest-admin"
}
```

### 2. 在代码中使用

```typescript
const message = i18n.t('common.welcome')
```

## 错误消息映射

系统会自动将错误代码映射到翻译键：

| 错误代码 | 翻译键 | 说明 |
|---------|--------|------|
| 1017 | `error.USER_NOT_FOUND` | 用户不存在 |
| 1003 | `error.INVALID_USERNAME_PASSWORD` | 用户名或密码错误 |
| 500 | `error.SERVER_ERROR` | 服务器错误 |
| 401 | `error.UNAUTHORIZED` | 未授权 |
| 403 | `error.FORBIDDEN` | 禁止访问 |
| 404 | `error.NOT_FOUND` | 资源未找到 |
| 400 | `error.BAD_REQUEST` | 请求错误 |

## 架构设计

### 语言解析器

`CustomLanguageResolver` 实现了自定义语言解析逻辑：

```typescript
@Injectable()
export class CustomLanguageResolver implements I18nResolver {
  resolve(context: any): string | Promise<string> | undefined {
    // 1. 用户偏好
    // 2. 自定义 header
    // 3. Accept-Language
    // 4. 默认语言
  }
}
```

### 异常过滤器集成

`AllExceptionsFilter` 集成了 I18N，自动翻译错误消息：

```typescript
const i18n = I18nContext.current()
if (i18n) {
  const translated = i18n.t(`error.${errorKey}`, { defaultValue: message })
  message = translated
}
```

## 测试

### 测试不同语言

使用 curl 测试：

```bash
# 测试中文
curl -H "x-custom-lang: zh" http://localhost:3000/api/users

# 测试英文
curl -H "x-custom-lang: en" http://localhost:3000/api/users

# 测试 Accept-Language
curl -H "Accept-Language: en" http://localhost:3000/api/users
```

## 注意事项

1. **语言代码**：使用 ISO 639-1 语言代码（如 `zh`, `en`, `ja`）

2. **默认值**：如果翻译不存在，会使用 `defaultValue` 或原始消息

3. **性能**：I18N 资源文件会在开发模式下自动监听变化

4. **上下文**：确保在请求上下文中使用 `I18nContext.current()`

5. **错误处理**：如果 I18N 翻译失败，会回退到原始消息

## 扩展新语言

### 步骤

1. 创建语言文件夹：
   ```bash
   mkdir -p src/i18n/ja
   ```

2. 复制并翻译资源文件：
   ```bash
   cp src/i18n/zh/common.json src/i18n/ja/common.json
   cp src/i18n/zh/error.json src/i18n/ja/error.json
   ```

3. 翻译内容为日语

4. 使用新语言：
   ```http
   x-custom-lang: ja
   ```

## 故障排查

### 问题：翻译不生效

**检查项**：
1. 确认语言资源文件存在
2. 检查翻译键是否正确
3. 验证语言解析器配置
4. 查看服务器日志

### 问题：语言检测失败

**检查项**：
1. 确认 header 名称配置正确
2. 检查 Accept-Language 格式
3. 验证默认语言配置

## 最佳实践

1. **统一翻译键**：使用命名空间组织翻译键（如 `common.*`, `error.*`）

2. **默认值**：始终提供 `defaultValue` 作为后备

3. **语言资源管理**：定期审查和更新翻译内容

4. **测试覆盖**：为所有语言编写测试用例

5. **文档**：为新添加的翻译键编写文档

## 相关文档

- [nestjs-i18n 官方文档](https://nestjs-i18n.com/)
- [错误处理文档](./04-错误处理.md)
