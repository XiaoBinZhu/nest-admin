# E2E 测试使用指南

## 概述

nest-admin 现在包含完整的 E2E（端到端）测试框架和示例。本文档介绍如何编写和运行 E2E 测试。

## 功能特性

- ✅ Jest 测试框架
- ✅ Supertest HTTP 测试
- ✅ 认证测试示例
- ✅ 文件上传测试示例
- ✅ 测试工具和常量

## 项目结构

```
test/
├── auth/
│   └── auth.e2e-spec.ts      # 认证模块测试
├── upload/
│   └── upload.e2e-spec.ts    # 上传模块测试
├── utils/
│   └── constants.ts           # 测试常量
└── jest-e2e.json             # Jest E2E 配置
```

## 配置说明

### Jest 配置

`test/jest-e2e.json` 配置文件：

```json
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  },
  "moduleNameMapper": {
    "^~/(.*)$": "<rootDir>/../src/$1"
  }
}
```

### 测试常量

`test/utils/constants.ts`：

```typescript
export const APP_URL = `http://localhost:${process.env.APP_PORT || 3000}`
export const TESTER_USERNAME = 'test'
export const TESTER_PASSWORD = '123456'
export const ADMIN_USERNAME = 'admin'
export const ADMIN_PASSWORD = 'admin123'
```

## 运行测试

### 运行所有 E2E 测试

```bash
pnpm test:e2e
```

### 运行特定测试文件

```bash
pnpm test:e2e -- auth/auth.e2e-spec.ts
```

### 监听模式

```bash
pnpm test:e2e -- --watch
```

## 编写测试

### 认证测试示例

```typescript
import request from 'supertest'
import { APP_URL, TESTER_PASSWORD, TESTER_USERNAME } from '../utils/constants'

describe('Auth Module (e2e)', () => {
  const app = APP_URL
  let authToken: string

  describe('Login', () => {
    it('should fail with invalid credentials', () => {
      return request(app)
        .post('/auth/login')
        .send({
          username: 'invalid',
          password: 'invalid',
          captchaId: 'test',
          verifyCode: '1234',
        })
        .expect((res) => {
          expect([400, 401, 422]).toContain(res.status)
        })
    })

    it('should successfully login', () => {
      return request(app)
        .post('/auth/login')
        .send({
          username: TESTER_USERNAME,
          password: TESTER_PASSWORD,
          captchaId: 'test',
          verifyCode: '1234',
        })
        .expect(200)
        .expect(({ body }) => {
          expect(body.token).toBeDefined()
          authToken = body.token
        })
    })
  })
})
```

### 文件上传测试示例

```typescript
import * as path from 'node:path'
import request from 'supertest'
import { APP_URL, TESTER_PASSWORD, TESTER_USERNAME } from '../utils/constants'

describe('Upload Module (e2e)', () => {
  const app = APP_URL
  let authToken: string

  beforeAll(async () => {
    // 登录获取 token
    const response = await request(app)
      .post('/auth/login')
      .send({
        username: TESTER_USERNAME,
        password: TESTER_PASSWORD,
        captchaId: 'test',
        verifyCode: '1234',
      })
    authToken = response.body.token
  })

  it('should upload file successfully', () => {
    const testFilePath = path.join(__dirname, '../fixtures/test-image.jpg')

    return request(app)
      .post('/tools/upload')
      .set('Authorization', `Bearer ${authToken}`)
      .attach('file', testFilePath)
      .expect(200)
      .expect(({ body }) => {
        expect(body.filename).toBeDefined()
      })
  })
})
```

## 测试最佳实践

### 1. 测试结构

```typescript
describe('Module Name (e2e)', () => {
  // 共享变量
  let authToken: string

  // 前置准备
  beforeAll(async () => {
    // 初始化数据
  })

  // 后置清理
  afterAll(async () => {
    // 清理数据
  })

  // 测试用例
  describe('Feature', () => {
    it('should do something', () => {
      // 测试逻辑
    })
  })
})
```

### 2. 使用测试常量

```typescript
``

### 3. 认证处理

```typescript
beforeAll(async () => {
  const response = await request(APP_URL)
    .post('/auth/login')
    .send({
      username: TESTER_USERNAME,
      password: TESTER_PASSWORD,
      captchaId: 'test',
      verifyCode: '1234',
    })
  authToken = response.body.token
})
```

### 4. 错误处理

```typescript
it('should handle errors', () => {
  return request(APP_URL)
    .get('/api/invalid')
    .expect(404)
    .expect(({ body }) => {
      expect(body.message).toBeDefined()
    })
})
```

## 测试数据管理

### 创建测试数据

```typescript
beforeAll(async () => {
  // 创建测试用户
  await request(APP_URL)
    .post('/api/users')
    .send({
      username: 'testuser',
      password: 'password',
    })
})
```

### 清理测试数据

```typescript
afterAll(async () => {
  // 删除测试用户
  await request(APP_URL)
    .delete('/api/users/testuser')
})
```

## 环境配置

### 测试环境变量

创建 `.env.test` 文件：

```env
NODE_ENV=test
APP_PORT=3001
DB_DATABASE=nest_admin_test
```

### 运行测试前准备

1. 确保测试数据库已创建
2. 运行数据库迁移
3. 启动应用服务器

## 持续集成

### GitHub Actions 示例

```yaml
name: E2E Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
      - run: pnpm install
      - run: pnpm test:e2e
```

## 故障排查

### 问题：测试超时

**解决方案**：
1. 增加超时时间：`jest.setTimeout(30000)`
2. 检查服务器是否运行
3. 验证数据库连接

### 问题：认证失败

**解决方案**：
1. 确认测试用户存在
2. 检查验证码处理
3. 验证 token 格式

### 问题：文件上传失败

**解决方案**：
1. 确认测试文件存在
2. 检查文件权限
3. 验证存储驱动配置

## 相关文档

- [Jest 官方文档](https://jestjs.io/)
- [Supertest 文档](https://github.com/visionmedia/supertest)
- [测试最佳实践](./05-测试最佳实践.md)
