# 多数据库支持使用指南

## 概述

nest-admin 现在支持多种数据库类型，包括关系型数据库（MySQL、PostgreSQL）和文档数据库（MongoDB）。本文档介绍如何配置和切换不同的数据库。

## 功能特性

- ✅ 支持 MySQL（默认）
- ✅ 支持 PostgreSQL
- ✅ 支持 MongoDB
- ✅ 自动根据配置选择数据库驱动
- ✅ 保持向后兼容，不影响现有 MySQL 配置

## 配置说明

### 环境变量配置

在 `.env` 文件中配置数据库类型和连接信息：

#### MySQL 配置（默认）

```env
DB_TYPE=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=password
DB_DATABASE=nest_admin
DB_SYNCHRONIZE=false
```

#### PostgreSQL 配置

```env
DB_TYPE=postgres
DB_HOST=127.0.0.1
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=password
DB_DATABASE=nest_admin
DB_SYNCHRONIZE=false
```

#### MongoDB 配置

```env
DB_TYPE=mongodb
DB_HOST=127.0.0.1
DB_PORT=27017
DB_USERNAME=admin
DB_PASSWORD=password
DB_DATABASE=nest_admin

# 或使用连接字符串
DB_URL=mongodb://admin:password@127.0.0.1:27017/nest_admin
```

### 配置项说明

| 配置项 | 说明 | 必填 | 默认值 |
|--------|------|------|--------|
| `DB_TYPE` | 数据库类型 | 是 | `mysql` |
| `DB_HOST` | 数据库主机 | 是 | `127.0.0.1` |
| `DB_PORT` | 数据库端口 | 否 | MySQL: 3306, PostgreSQL: 5432 |
| `DB_USERNAME` | 数据库用户名 | 是 | - |
| `DB_PASSWORD` | 数据库密码 | 是 | - |
| `DB_DATABASE` | 数据库名称 | 是 | - |
| `DB_URL` | 数据库连接字符串（MongoDB） | 否（MongoDB 可选） | - |
| `DB_SYNCHRONIZE` | 是否自动同步表结构 | 否 | `false` |

## 使用方法

### 1. 切换数据库类型

只需修改 `.env` 文件中的 `DB_TYPE` 配置：

```env
# 使用 MySQL
DB_TYPE=mysql

# 使用 PostgreSQL
DB_TYPE=postgres

# 使用 MongoDB
DB_TYPE=mongodb
```

### 2. 在代码中使用数据库

#### TypeORM（关系型数据库）

```typescript
import { Injectable } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import { Repository } from 'typeorm'
import { UserEntity } from './user.entity'

@Injectable()
export class UserService {
  constructor(
    @InjectRepository(UserEntity)
    private userRepository: Repository<UserEntity>,
  ) {}

  async findAll() {
    return this.userRepository.find()
  }
}
```

#### Mongoose（MongoDB）

```typescript
import { Injectable } from '@nestjs/common'
import { InjectModel } from '@nestjs/mongoose'
import { Model } from 'mongoose'
import { User, UserDocument } from './user.schema'

@Injectable()
export class UserService {
  constructor(
    @InjectModel(User.name)
    private userModel: Model<UserDocument>,
  ) {}

  async findAll() {
    return this.userModel.find().exec()
  }
}
```

## 架构设计

### 数据库模块选择

系统会根据 `DB_TYPE` 配置自动选择数据库模块：

```typescript
// 如果 DB_TYPE=mongodb，使用 MongooseModule
// 否则使用 TypeOrmModule
const infrastructureDatabaseModule = isDocumentDatabase
  ? MongooseModule.forRootAsync({
      useClass: MongooseConfigService,
    })
  : TypeOrmModule.forRootAsync({
      useClass: TypeOrmConfigService,
    })
```

### 配置服务

- **TypeOrmConfigService**: 关系型数据库配置服务
- **MongooseConfigService**: MongoDB 配置服务

## 迁移指南

### 从 MySQL 迁移到 PostgreSQL

1. 修改 `.env` 配置：
   ```env
   DB_TYPE=postgres
   DB_PORT=5432
   ```

2. 安装 PostgreSQL 驱动（已包含）：
   ```bash
   pnpm add pg
   ```

3. 运行迁移：
   ```bash
   pnpm migration:run
   ```

### 从关系型数据库迁移到 MongoDB

1. 修改 `.env` 配置：
   ```env
   DB_TYPE=mongodb
   ```

2. 安装 MongoDB 驱动（已包含）：
   ```bash
   pnpm add @nestjs/mongoose mongoose
   ```

3. 将实体转换为 Schema：
   ```typescript
   // TypeORM Entity
   @Entity('users')
   export class User {
     @PrimaryGeneratedColumn()
     id: number

     @Column()
     name: string
   }

   // Mongoose Schema
   @Schema()
   export class User {
     @Prop()
     name: string
   }
   ```

## 注意事项

1. **数据迁移**：切换数据库类型时，需要手动迁移数据，系统不会自动迁移

2. **实体/Schema 兼容性**：
   - TypeORM 实体和 Mongoose Schema 不兼容
   - 需要为不同数据库类型创建对应的实体定义

3. **查询语法**：
   - TypeORM 使用 SQL 查询语法
   - Mongoose 使用 MongoDB 查询语法

4. **事务支持**：
   - MySQL/PostgreSQL 支持事务
   - MongoDB 4.0+ 支持多文档事务

5. **索引**：
   - TypeORM 使用数据库索引
   - Mongoose 使用 MongoDB 索引

## 故障排查

### 问题：连接失败

**检查项**：
1. 验证数据库服务是否运行
2. 检查连接配置是否正确
3. 确认网络连接和防火墙设置
4. 查看数据库日志

### 问题：表/集合不存在

**检查项**：
1. 确认数据库名称正确
2. 检查迁移是否执行
3. 验证实体/Schema 定义

### 问题：类型不匹配

**检查项**：
1. 确认使用了正确的数据库类型
2. 检查实体/Schema 定义
3. 验证查询语法

## 最佳实践

1. **开发环境**：使用 MySQL 或 PostgreSQL
2. **生产环境**：根据业务需求选择数据库类型
3. **数据备份**：定期备份数据库
4. **性能优化**：根据数据库类型优化查询
5. **监控**：监控数据库连接和性能指标

## 相关文档

- [TypeORM 官方文档](https://typeorm.io/)
- [Mongoose 官方文档](https://mongoosejs.com/)
- [数据库迁移文档](./03-数据库迁移.md)
