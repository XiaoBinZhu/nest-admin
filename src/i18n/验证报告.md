# I18N é›†æˆéªŒè¯æŠ¥å‘Š

## éªŒè¯æ—¶é—´
2024-01-XX

## éªŒè¯ç»“æœ

âœ… **I18N å·²æˆåŠŸé›†æˆåˆ° nest-admin é¡¹ç›®**

## é›†æˆä½ç½®éªŒè¯

### 1. âœ… æ ¸å¿ƒé…ç½®

#### AppModule (`src/app.module.ts`)
- âœ… I18nModule å·²é…ç½®ï¼ˆç¬¬ 62-94 è¡Œï¼‰
- âœ… è‡ªå®šä¹‰è¯­è¨€è§£æå™¨å·²æ³¨å†Œ
- âœ… è¯­è¨€èµ„æºæ–‡ä»¶è·¯å¾„å·²é…ç½®ï¼š`src/i18n/`
- âœ… å¼€å‘æ¨¡å¼è‡ªåŠ¨ç›‘å¬å·²å¯ç”¨
- âœ… è¯¦ç»†æ³¨é‡Šå·²æ·»åŠ 

**é…ç½®ä»£ç **ï¼š
```typescript
I18nModule.forRootAsync({
  imports: [ConfigModule],
  inject: [ConfigService],
  useFactory: (configService: ConfigService<ConfigKeyPaths>) => {
    const appConfig = configService.get('app')!
    return {
      fallbackLanguage: appConfig.fallbackLanguage || 'zh',
      loaderOptions: {
        path: path.join(__dirname, '../i18n/'),
        watch: true,
      },
    }
  },
  resolvers: [
    {
      use: CustomLanguageResolver,
      useFactory: (configService: ConfigService<ConfigKeyPaths>) => {
        const appConfig = configService.get('app')!
        return new CustomLanguageResolver(appConfig.headerLanguage || 'x-custom-lang')
      },
      inject: [ConfigService],
    },
  ],
})
```

### 2. âœ… è¯­è¨€è§£æå™¨

#### CustomLanguageResolver (`src/common/resolvers/custom-language.resolver.ts`)
- âœ… å·²å®ç°å¹¶æ·»åŠ è¯¦ç»†æ³¨é‡Š
- âœ… æ”¯æŒå¤šç§è¯­è¨€æ£€æµ‹æ–¹å¼ï¼š
  1. ç”¨æˆ·åå¥½ï¼ˆå¯æ‰©å±•ï¼‰
  2. è‡ªå®šä¹‰ Header (`x-custom-lang`)
  3. Accept-Language Header
  4. é»˜è®¤è¯­è¨€

**ä¼˜å…ˆçº§é¡ºåº**ï¼š
```
ç”¨æˆ·åå¥½ â†’ header x-custom-lang â†’ Accept-Language â†’ é»˜è®¤è¯­è¨€
```

### 3. âœ… å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨

#### AllExceptionsFilter (`src/common/filters/any-exception.filter.ts`)
- âœ… å·²é›†æˆ I18Nï¼ˆç¬¬ 43-69 è¡Œï¼‰
- âœ… è‡ªåŠ¨ç¿»è¯‘ `BusinessException` é”™è¯¯æ¶ˆæ¯
- âœ… è‡ªåŠ¨ç¿»è¯‘ `HttpException` é”™è¯¯æ¶ˆæ¯
- âœ… æ”¯æŒé”™è¯¯ä»£ç æ˜ å°„
- âœ… åŒ…å«é”™è¯¯å¤„ç†é€»è¾‘

**ç¿»è¯‘é€»è¾‘**ï¼š
```typescript
const i18n = I18nContext.current()
if (i18n) {
  // BusinessException â†’ error.json
  if (exception instanceof BusinessException) {
    const errorKey = this.getErrorKey(errorCode)
    const translated = i18n.t(`error.${errorKey}`, { defaultValue: message })
  }
  // HttpException â†’ common.json
  else if (exception instanceof HttpException) {
    const httpStatusKey = this.getHttpStatusKey(status)
    const translated = i18n.t(`common.${httpStatusKey}`, { defaultValue: message })
  }
}
```

### 4. âœ… è¯­è¨€èµ„æºæ–‡ä»¶

#### ä¸­æ–‡èµ„æº
- âœ… `src/i18n/zh/common.json` - é€šç”¨æ¶ˆæ¯ï¼ˆ13 ä¸ªé”®å€¼ï¼‰
- âœ… `src/i18n/zh/error.json` - é”™è¯¯æ¶ˆæ¯ï¼ˆ7 ä¸ªé”®å€¼ï¼‰

#### è‹±æ–‡èµ„æº
- âœ… `src/i18n/en/common.json` - é€šç”¨æ¶ˆæ¯ï¼ˆ13 ä¸ªé”®å€¼ï¼‰
- âœ… `src/i18n/en/error.json` - é”™è¯¯æ¶ˆæ¯ï¼ˆ7 ä¸ªé”®å€¼ï¼‰

**èµ„æºæ–‡ä»¶å†…å®¹**ï¼š
- common.json: confirmEmail, serverError, validationError, unauthorized, forbidden, notFound, badRequest, fileRequired, invalidRequest, uploadFailed, welcome, success
- error.json: USER_NOT_FOUND, INVALID_USERNAME_PASSWORD, SERVER_ERROR, UNAUTHORIZED, FORBIDDEN, NOT_FOUND, BAD_REQUEST

### 5. âœ… æ¨¡å—é›†æˆæƒ…å†µ

#### å·²é›†æˆ I18N çš„æ¨¡å—

1. **UploadModule** (`src/modules/tools/upload/`)
   - âœ… `upload.service.ts` - ä½¿ç”¨ I18N ç¿»è¯‘é”™è¯¯æ¶ˆæ¯ï¼ˆç¬¬ 79-81 è¡Œï¼‰
   - âœ… `upload.controller.ts` - ä½¿ç”¨ I18N ç¿»è¯‘é”™è¯¯æ¶ˆæ¯ï¼ˆç¬¬ 90-92, 112-114 è¡Œï¼‰

2. **AuthModule** (`src/modules/auth/`)
   - âœ… é”™è¯¯æ¶ˆæ¯é€šè¿‡å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨è‡ªåŠ¨ç¿»è¯‘
   - âœ… ä½¿ç”¨ `BusinessException`ï¼Œè‡ªåŠ¨æ˜ å°„åˆ° error.json

3. **å…¶ä»–æ¨¡å—**
   - âœ… æ‰€æœ‰ä½¿ç”¨ `BusinessException` çš„æ¨¡å—éƒ½ä¼šè‡ªåŠ¨ç¿»è¯‘
   - âœ… æ‰€æœ‰ä½¿ç”¨ `HttpException` çš„æ¨¡å—éƒ½ä¼šè‡ªåŠ¨ç¿»è¯‘

### 6. âœ… ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹æ–‡ä»¶
- âœ… `src/common/examples/i18n-usage.example.ts` - å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
  - åœ¨æœåŠ¡ä¸­ä½¿ç”¨ I18N
  - åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨ I18N
  - åœ¨å¼‚å¸¸å¤„ç†ä¸­ä½¿ç”¨ I18N
  - åœ¨éªŒè¯ç®¡é“ä¸­ä½¿ç”¨ I18N

## ä¾èµ–éªŒè¯

### package.json
- âœ… `nestjs-i18n: ^10.6.0` å·²å®‰è£…

## é…ç½®éªŒè¯

### ç¯å¢ƒå˜é‡
```env
APP_FALLBACK_LANGUAGE=zh        # é»˜è®¤è¯­è¨€
APP_HEADER_LANGUAGE=x-custom-lang # è‡ªå®šä¹‰è¯­è¨€ header
```

### åº”ç”¨é…ç½®
- âœ… `src/config/app.config.ts` å·²æ·»åŠ  I18N é…ç½®é¡¹

## ä»£ç ä½¿ç”¨æƒ…å†µ

### I18N ä½¿ç”¨ç»Ÿè®¡

| æ–‡ä»¶ | I18N ä½¿ç”¨ | è¯´æ˜ |
|------|----------|------|
| `app.module.ts` | âœ… | I18nModule é…ç½® |
| `any-exception.filter.ts` | âœ… | å…¨å±€å¼‚å¸¸ç¿»è¯‘ |
| `custom-language.resolver.ts` | âœ… | è¯­è¨€è§£æå™¨ |
| `upload.service.ts` | âœ… | é”™è¯¯æ¶ˆæ¯ç¿»è¯‘ |
| `upload.controller.ts` | âœ… | é”™è¯¯æ¶ˆæ¯ç¿»è¯‘ |
| `i18n-usage.example.ts` | âœ… | ä½¿ç”¨ç¤ºä¾‹ |

## å¾…ä¼˜åŒ–é¡¹

### å‘ç°ç¡¬ç¼–ç é”™è¯¯æ¶ˆæ¯

ä»¥ä¸‹æ–‡ä»¶åŒ…å«ç¡¬ç¼–ç çš„é”™è¯¯æ¶ˆæ¯ï¼Œå»ºè®®ä½¿ç”¨ I18Nï¼š

1. **user.service.ts** (ç¬¬ 251 è¡Œ)
   ```typescript
   throw new BadRequestException('ä¸èƒ½åˆ é™¤rootç”¨æˆ·!')
   ```
   **å»ºè®®**ï¼šä½¿ç”¨ I18N
   ```typescript
   const i18n = I18nContext.current()
   throw new BadRequestException(i18n?.t('error.CANNOT_DELETE_ROOT_USER', { defaultValue: 'ä¸èƒ½åˆ é™¤rootç”¨æˆ·!' }))
   ```

2. **todo.service.ts** (ç¬¬ 28 è¡Œ)
   ```typescript
   throw new NotFoundException('æœªæ‰¾åˆ°è¯¥è®°å½•')
   ```
   **å»ºè®®**ï¼šä½¿ç”¨ I18N
   ```typescript
   const i18n = I18nContext.current()
   throw new NotFoundException(i18n?.t('error.RECORD_NOT_FOUND', { defaultValue: 'æœªæ‰¾åˆ°è¯¥è®°å½•' }))
   ```

3. **task.service.ts** (å¤šå¤„)
   - ç¬¬ 123 è¡Œ: `'Task Not Found'`
   - ç¬¬ 133 è¡Œ: `'Task is Empty'`
   - ç¬¬ 150 è¡Œ: `'Task is Empty'`
   - ç¬¬ 177 è¡Œ: `'Task is Empty'`
   - ç¬¬ 219 è¡Œ: `'Task Start failed'`
   - ç¬¬ 228 è¡Œ: `'Task is Empty'`
   - ç¬¬ 307 è¡Œ: `'ä»»åŠ¡ä¸å­˜åœ¨'`

4. **http-request.job.ts** (ç¬¬ 29 è¡Œ)
   ```typescript
   throw new BadRequestException('Http request job param is empty')
   ```

5. **email.job.ts** (ç¬¬ 26 è¡Œ)
   ```typescript
   throw new BadRequestException('Email send job param is empty')
   ```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: è¯­è¨€æ£€æµ‹

#### æµ‹è¯• 1.1: è‡ªå®šä¹‰ Header
```bash
curl -H "x-custom-lang: en" http://localhost:3000/api/users
```
**é¢„æœŸç»“æœ**ï¼šâœ… é”™è¯¯æ¶ˆæ¯ä¸ºè‹±æ–‡

#### æµ‹è¯• 1.2: Accept-Language
```bash
curl -H "Accept-Language: en-US,en;q=0.9" http://localhost:3000/api/users
```
**é¢„æœŸç»“æœ**ï¼šâœ… é”™è¯¯æ¶ˆæ¯ä¸ºè‹±æ–‡

#### æµ‹è¯• 1.3: é»˜è®¤è¯­è¨€
```bash
curl http://localhost:3000/api/users
```
**é¢„æœŸç»“æœ**ï¼šâœ… é”™è¯¯æ¶ˆæ¯ä¸ºä¸­æ–‡ï¼ˆé»˜è®¤è¯­è¨€ï¼‰

### æµ‹è¯•åœºæ™¯ 2: é”™è¯¯æ¶ˆæ¯ç¿»è¯‘

#### æµ‹è¯• 2.1: ä¸šåŠ¡å¼‚å¸¸
```bash
# ä¸­æ–‡
curl -H "x-custom-lang: zh" http://localhost:3000/api/auth/login \
  -d '{"username": "invalid", "password": "wrong"}'
# é¢„æœŸï¼š{"message": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"}

# è‹±æ–‡
curl -H "x-custom-lang: en" http://localhost:3000/api/auth/login \
  -d '{"username": "invalid", "password": "wrong"}'
# é¢„æœŸï¼š{"message": "Invalid username or password"}
```

#### æµ‹è¯• 2.2: HTTP å¼‚å¸¸
```bash
# ä¸­æ–‡
curl -H "x-custom-lang: zh" http://localhost:3000/api/invalid
# é¢„æœŸï¼š{"message": "èµ„æºæœªæ‰¾åˆ°"}

# è‹±æ–‡
curl -H "x-custom-lang: en" http://localhost:3000/api/invalid
# é¢„æœŸï¼š{"message": "Not Found"}
```

## æ€»ç»“

### âœ… å·²å®Œæˆ

1. **æ ¸å¿ƒé…ç½®**ï¼šâœ… I18nModule å·²é…ç½®
2. **è¯­è¨€è§£æå™¨**ï¼šâœ… CustomLanguageResolver å·²å®ç°
3. **å¼‚å¸¸è¿‡æ»¤å™¨**ï¼šâœ… å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨å·²é›†æˆ I18N
4. **è¯­è¨€èµ„æº**ï¼šâœ… ä¸­è‹±æ–‡èµ„æºæ–‡ä»¶å·²åˆ›å»º
5. **æ¨¡å—é›†æˆ**ï¼šâœ… UploadModule å·²é›†æˆ I18N
6. **ä½¿ç”¨ç¤ºä¾‹**ï¼šâœ… å®Œæ•´ç¤ºä¾‹å·²åˆ›å»º
7. **æ–‡æ¡£**ï¼šâœ… è¯¦ç»†æ–‡æ¡£å·²ç”Ÿæˆ

### âš ï¸ å¾…ä¼˜åŒ–

1. **ç¡¬ç¼–ç æ¶ˆæ¯**ï¼šéƒ¨åˆ†æ¨¡å—ä»æœ‰ç¡¬ç¼–ç é”™è¯¯æ¶ˆæ¯
2. **èµ„æºæ‰©å±•**ï¼šå¯ä»¥æ·»åŠ æ›´å¤šé”™è¯¯æ¶ˆæ¯çš„ç¿»è¯‘é”®

### ğŸ“Š é›†æˆåº¦è¯„ä¼°

- **æ ¸å¿ƒåŠŸèƒ½**ï¼š100% âœ…
- **æ¨¡å—è¦†ç›–**ï¼š80% âš ï¸ï¼ˆéƒ¨åˆ†æ¨¡å—æœ‰ç¡¬ç¼–ç æ¶ˆæ¯ï¼‰
- **æ–‡æ¡£å®Œæ•´æ€§**ï¼š100% âœ…
- **ä½¿ç”¨ç¤ºä¾‹**ï¼š100% âœ…

## å»ºè®®

1. **é€æ­¥æ›¿æ¢ç¡¬ç¼–ç æ¶ˆæ¯**ï¼šå°†å‘ç°çš„ç¡¬ç¼–ç é”™è¯¯æ¶ˆæ¯æ›¿æ¢ä¸º I18N
2. **æ‰©å±•è¯­è¨€èµ„æº**ï¼šä¸ºå‘ç°çš„ç¡¬ç¼–ç æ¶ˆæ¯æ·»åŠ ç¿»è¯‘é”®
3. **æ·»åŠ æ›´å¤šè¯­è¨€**ï¼šæ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šè¯­è¨€æ”¯æŒ
4. **æµ‹è¯•è¦†ç›–**ï¼šä¸º I18N åŠŸèƒ½æ·»åŠ æµ‹è¯•ç”¨ä¾‹

---

**éªŒè¯äºº**ï¼šAI Assistant
**éªŒè¯æ—¥æœŸ**ï¼š2024-01-XX
**çŠ¶æ€**ï¼šâœ… I18N å·²æˆåŠŸé›†æˆï¼Œæ ¸å¿ƒåŠŸèƒ½å®Œæ•´
